<!DOCTYPE html>
<html>
<head>
    <title>Display Figures</title>
</head>
<body>
    {% if cities is defined %}
        <label for="city">
            Select a city:
            <select>
                <option value="">Select a city</option>
                {% for city in cities %}
                    <option value="{{ city }}">{{ city }}</option>
                {% endfor %}
            </select>
        </label>

        <label for="latitude">
            Latitude:
            <input type="number" step="0.00000000000001" name="latitude" value="{{ latitude }}">
        </label>

        <label for="altitude">
            Altitude:
            <input type="number" name="altitude" value="{{ altitude }}">
        </label>

        <button type="button" onclick="search()">Search</button>
    {% else %}
        <p>No cities found. Search is not available</p>
    {% endif %}

    <div id="figures"></div>

    {% if figures is defined %}
        {% for figure in figures %}
            <img src="{{ url_for('static', filename='figure' + loop.index|string + '.png') }}" alt="Figure {{ loop.index }}">
        {% endfor %}
    {% endif %}
</body>
<script>
    // When city is selected, update latitude and altitude
    let city = document.querySelector('select');
    let latitude = document.querySelector('input[name="latitude"]');
    let altitude = document.querySelector('input[name="altitude"]');
    let figures = document.querySelector('#figures');

    city.addEventListener('change', function() {
        let city = this.value;
        let xhr = new XMLHttpRequest();
        xhr.open('GET', '/penmon/city/' + city);
        xhr.onload = function() {
            let data = JSON.parse(xhr.responseText);
            latitude.value = data.latitude;
            altitude.value = data.altitude;
        };
        xhr.send();
    });

    // When button "Search" is clicked, post form
    search = () => {
        // Post form
        let xhr = new XMLHttpRequest();
        xhr.open('POST', '/penmon');
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.send(JSON.stringify({
            city: city.value,
            latitude: latitude.value,
            altitude: altitude.value
        }));
        xhr.onload = () => {
            let data = JSON.parse(xhr.responseText);
            if (data && data.figures) {
                data.figures.map((figure) => {
                    let img = document.createElement('img');
                    img.src = '/static/' + figure;
                    img.alt = figure;
                    figures.appendChild(img);
                })
            } else {
                figures = '<div id="figures"></div>';
            }
        };
    }
</script>
</html>